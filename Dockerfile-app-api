#################
# Maven Build App #
#################
FROM maven:3.8.4-eclipse-temurin-11 AS build  

ARG API_GATEWAY_PORT=DEFAULT
ARG EUREKA_SERVER_PORT=DEFAULT
ARG CONFIG_SERVER_PORT=DEFAULT
ARG CONFIG_SERVER_SECURITY_NAME=DEFAULT
ARG CONFIG_SERVER_SECURITY_PASS=DEFAULT
ARG AUTHORIZATION_JWT_SECRET=DEFAULT
ARG AUTHENTICATION_USER=DEFAULT
ARG AUTHENTICATION_PASS=DEFAULT
ARG PG_HOST_SERVER=DEFAULT
ARG PG_HOST_SERVER_PORT=DEFAULT
ARG PG_IMAGE_TAG=DEFAULT
ARG PG_USER=DEFAULT
ARG PG_PASS=DEFAULT
ARG PG_DB_NAME=DEFAULT
ARG PG_USER_ADMIN=DEFAULT
ARG PG_PASS_ADMIN=DEFAULT
ARG SQL_USER_NAME_1=DEFAULT
ARG SQL_USER_NAME_2=DEFAULT
ARG PATH_FILE
ARG EUREKA_HOST_SERVER
ARG CONFIG_SERVER_HOST

ENV API_GATEWAY_PORT $API_GATEWAY_PORT
ENV EUREKA_SERVER_PORT $EUREKA_SERVER_PORT
ENV CONFIG_SERVER_PORT $CONFIG_SERVER_PORT
ENV CONFIG_SERVER_SECURITY_NAME $CONFIG_SERVER_SECURITY_NAME
ENV CONFIG_SERVER_SECURITY_PASS $CONFIG_SERVER_SECURITY_PASS
ENV AUTHORIZATION_JWT_SECRET $AUTHORIZATION_JWT_SECRET
ENV AUTHENTICATION_USER $AUTHENTICATION_USER
ENV AUTHENTICATION_PASS $AUTHENTICATION_PASS
ENV PG_HOST_SERVER $PG_HOST_SERVER
ENV PG_HOST_SERVER_PORT $PG_HOST_SERVER_PORT
ENV PG_IMAGE_TAG $PG_IMAGE_TAG
ENV PG_USER $PG_USER
ENV PG_PASS $PG_PASS
ENV PG_DB_NAME $PG_DB_NAME
ENV PG_USER_ADMIN $PG_USER_ADMIN
ENV PG_PASS_ADMIN $PG_PASS_ADMIN
ENV SQL_USER_NAME_1 $SQL_USER_NAME_1
ENV SQL_USER_NAME_2 $SQL_USER_NAME_2
ENV EUREKA_HOST_SERVER $EUREKA_HOST_SERVER
ENV CONFIG_SERVER_HOST $CONFIG_SERVER_HOST

WORKDIR /usr/src/app
COPY . .

#RUN mvn clean install -P prod
RUN mvn -f ./app-api/$PATH_FILE/ clean install

################
# Run APP API #
################
FROM openjdk:11
ARG PATH_FILE
VOLUME /tmp
COPY --from=build "/usr/src/app/app-api/$PATH_FILE/target/*.jar" app.jar
ENTRYPOINT ["java","-jar","/app.jar"]

