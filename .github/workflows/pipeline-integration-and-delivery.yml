name: Pipeline Continuous Integration and Delivery
on:
  pull_request:
    branches:
      - 'main'
      - 'release/**'
      - 'develop'
  push:
    branches:
      - 'main'
      - 'release/**'
      - 'develop'
    paths-ignore:
      - 'app/resources/**'
  workflow_dispatch:
jobs:
  env_preparate:
    name: Identifying the Environment
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      EVENT_TYPE: ${{ github.event_name }} 
    outputs:
      env_name: ${{ steps.env_name.outputs.env_name }}
    steps:
      - name: Verify type Event
        if: contains(env.EVENT_TYPE, 'pull_request')
        run: echo "BRANCH_NAME=${{ github.base_ref }} " >> $GITHUB_ENV
      - name: Environment Production
        if: contains(${{ env.BRANCH_NAME }}, 'main')
        run: echo "defined_environment=production" >> $GITHUB_OUTPUT
      - name: Environment Homologation
        if: startsWith(${{ env.BRANCH_NAME }}, 'release')
        run: echo "defined_environment=homologation" >> $GITHUB_OUTPUT
      - name: Environment Development
        if: contains(${{ env.BRANCH_NAME }}, 'develop')
        run: echo "defined_environment=development" >> $GITHUB_OUTPUT
      - name: Defined Environment
        id: env_name
        run: echo "env_name=$defined_environment" >> $GITHUB_OUTPUT
        
  oper_prepare:
    name: Preparete Operation 
    runs-on: ubuntu-latest
    permissions: write-all
    needs: [env_preparate]
    environment:
      name: ${{needs.env_preparate.outputs.env_name}} 
    env:
      EVENT_TYPE: ${{ github.event_name }} 
      ENV_NAME: ${{needs.env_preparate.outputs.env_name}} 
    outputs:
      is_compile: ${{ steps.compile.outputs.compile || false }}
      is_build: ${{ steps.build.outputs.build || false }}
      is_deploy: ${{ steps.deploy.outputs.deploy || false}}
      is_release: ${{ steps.release.outputs.release || false}}
    steps:
      - name: Compile action definition
        id: compile
        if: contains(env.EVENT_TYPE, 'pull_request')
        run: echo "compile=true" >> $GITHUB_OUTPUT

      - name: Build action definition
        id: build
        if: contains(env.EVENT_TYPE, 'pull_request')
        run: echo "build=true" >> $GITHUB_OUTPUT

      - name: Deploy action definition
        id: deploy
        if: contains(env.EVENT_TYPE, 'pull_request') && env.ENV_NAME == 'release' || contains(env.EVENT_TYPE, 'push')
        run: echo "deploy=true" >> $GITHUB_OUTPUT

      - name: Release action definition
        id: release
        if: contains(env.EVENT_TYPE, 'push') && env.ENV_NAME == 'release'
        run: echo "release=true" >> $GITHUB_OUTPUT
  

  call-compile-app:
    needs: [oper_prepare]
    if: ${{needs.oper_prepare.outputs.is_compile}} 
    permissions: write-all
    uses: ./.github/workflows/run-app-compile.yml
  call-build-app:
    needs: [oper_prepare, env_preparate, call-compile-app]
    if: ${{needs.oper_prepare.outputs.is_build}} 
    permissions: write-all
    uses: ./.github/workflows/build-docker-image.yml
    strategy:
      matrix:
        images: [app-ui]
        paths: [./app-ui]
    with:
      env_name: ${{ needs.env_preparate.outputs.env_name }}
      build_number_org: ${{github.run_number}}-SNAPSHOT
      image_name: ${{ matrix.images }}
      path_dockerfile: ${{ matrix.paths }}
  call-deploy-app:
    needs: [oper_prepare, call-build-app]
    if: ${{needs.oper_prepare.outputs.is_deploy}} 
    permissions: write-all
    uses: ./.github/workflows/deploy.yml
  call-release:
    needs: [oper_prepare, call-deploy-app]
    if: ${{needs.oper_prepare.outputs.is_release}} 
    permissions: write-all
    uses: ./.github/workflows/create-release.yml



  